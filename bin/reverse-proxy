#!/usr/bin/env bash
set -eu

USE_SSL=0
HTTP_HOST=

function die_with_usage {
    echo "Usage: $0 [--ssl] <hostname>"
    if [[ $# -eq 2 ]]; then
        echo "  ($2)"
    fi
    exit $1
}

while [[ $# -gt 0 ]]; do
    case $1 in
        --ssl)
            USE_SSL=1
            shift
            ;;
        --help)
            die_with_usage 0
            ;;
        *)
            if [[ ! -z $HTTP_HOST ]]; then
                die_with_usage 1 "Unknown arg, or multiple position args"
            fi
            HTTP_HOST=$1
            shift
            ;;
    esac
done

if [[ -z $HTTP_HOST ]]; then
    die_with_usage 1 "No hostname given"
fi

if [[ $USE_SSL == 0 ]]; then
    CONFIG_SRC=nginx-http.conf
else
    CONFIG_SRC=nginx-https.conf
fi

echo "Using HTTP_HOST=$HTTP_HOST in $CONFIG_SRC"
envsubst '$HTTP_HOST' < /template/$CONFIG_SRC > /etc/nginx/nginx.conf

PATH_GO_SIGNAL=/run/proxy/go-signal

# Wait for indication that the site files have been created and the ssl certs (if used) have been copied into place
echo "Waiting for go signal at $PATH_GO_SIGNAL (use docker exec $HOSTNAME go-signal)"
while [[ ! -e $PATH_GO_SIGNAL ]]; do
    sleep 1
done

echo "Running nginx!"
exec nginx -g "daemon off;"
